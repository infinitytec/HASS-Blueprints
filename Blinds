blueprint:
  name: Blind Automation
  description: >
    Automates blinds to optimize solar heating and lighting. Opens blinds in cold weather to maximize solar heat gain. Closes blinds in hot weather to minimize heat ingress. Adjusts for sufficient natural lighting if outdoor illuminance is available.

  domain: automation

  input:
    outdoor_temperature:
      name: Outdoor Temperature
      description: Current outdoor temperature.
      selector:
        entity:
          filter:
            domain: sensor

    indoor_temperature:
      name: Indoor Temperature
      description: Current indoor temperature.
      selector:
        entity:
          filter:
            domain: sensor

    outdoor_illuminance:
      name: Outdoor Illuminance (optional)
      description: Optional outdoor brightness sensor.
      default: null
      selector:
        entity:
          filter:
            domain: sensor
            device_class: illuminance
          multiple: false
          include_entities:
            - null

mode: single
max_exceeded: silent

variables:
  illuminance: !input outdoor_illuminance
  has_illuminance: "{{ illuminance is not none and illuminance != '' }}"
  outdoor_temp: "{{ states(!input outdoor_temperature) | float(0) }}"
  indoor_temp: "{{ states(!input indoor_temperature) | float(0) }}"
  illum_val: "{{ states(illuminance) | float(0) if has_illuminance else 0 }}"
  temp_diff: "{{ (outdoor_temp - indoor_temp) | abs > 1.0 }}"
  blinds_open: "{{ is_state('cover.loft_blinds', 'open') }}"
  blinds_closed: "{{ is_state('cover.loft_blinds', 'closed') }}"

trigger:
  - platform: numeric_state
    entity_id: !input outdoor_temperature
  - platform: numeric_state
    entity_id: !input indoor_temperature
  - platform: template
    value_template: >
      {% if has_illuminance %}
        {{ illum_val > 2000 or illum_val < 1500 }}
      {% else %}
        false
      {% endif %}

conditions: []

actions:
  - choose:
      # Open blinds if outside is colder and illuminance is high OR missing
      - conditions:
          - condition: template
            value_template: "{{ temp_diff and outdoor_temp < indoor_temp }}"
          - condition: template
            value_template: >
              {% if has_illuminance %}
                {{ illum_val > 2000 }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: "{{ blinds_closed }}"
        sequence:
          - service: cover.open_cover
            target:
              entity_id: cover.loft_blinds

      # Close blinds if outside is hotter and illuminance is high OR missing
      - conditions:
          - condition: template
            value_template: "{{ temp_diff and outdoor_temp > indoor_temp }}"
          - condition: template
            value_template: >
              {% if has_illuminance %}
                {{ illum_val > 2000 }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: "{{ blinds_open }}"
        sequence:
          - service: cover.close_cover
            target:
              entity_id: cover.loft_blinds

      # Close blinds if outside is colder but it's too dark
      - conditions:
          - condition: template
            value_template: "{{ temp_diff and outdoor_temp < indoor_temp }}"
          - condition: template
            value_template: >
              {% if has_illuminance %}
                {{ illum_val < 1500 }}
              {% else %}
                false
              {% endif %}
          - condition: template
            value_template: "{{ blinds_open }}"
        sequence:
          - service: cover.close_cover
            target:
              entity_id: cover.loft_blinds

      # Open blinds if outside is hotter but it's too dark
      - conditions:
          - condition: template
            value_template: "{{ temp_diff and outdoor_temp > indoor_temp }}"
          - condition: template
            value_template: >
              {% if has_illuminance %}
                {{ illum_val < 1500 }}
              {% else %}
                false
              {% endif %}
          - condition: template
            value_template: "{{ blinds_closed }}"
        sequence:
          - service: cover.open_cover
            target:
              entity_id: cover.loft_blinds
    default: []
